# Reverse Proxy and SSO on Docker for a Private Server with Dynamic DNS
A setup for a private server with dynamic IP / reverse proxy, and SSO with Authentik or OpenID (OIDC)
## TL;DR
### Current Plan
An extensive conversation with ChatGPT results in the following setup:
- **Reverse Proxy**: Traefik (streamlined configuration in `traefik.yml` which can be referenced by each `docker-compose.yml`)
- **SSL**: Letsencrypt in Traefik
- **Authentication**:
  - via traefik-forward-auth
  - Synology SSO Server as OpenID Provider
 
#### ChatGPT Recommendation
To set up a **Traefik** reverse proxy in a Dockerized environment with **Let's Encrypt SSL** certificates for **domain.tld** and all of its subdomains, and to redirect traffic to a standard error page for the base domain, you will need to configure several key components:

1. **Docker Compose** for setting up Traefik and other services.
2. **Traefik Configuration File** to enable **Let's Encrypt**, handle routing, and configure the SSL.
3. Configuration to forward traffic to the **Synology SSO server**.
4. Ensure Traefik handles subdomains and redirects traffic from `domain.tld` to an error page.

### Assumptions:
- The domain is dynamic, so you will need a **dynamic DNS (DDNS)** setup to keep the domain pointing to your server.
- The router is already forwarding ports `80` and `443` to the correct internal ports `11420` and `11421`.
- Your Synology SSO server is accessible via `subdomain.domain.tld` (for example `sso.domain.tld`).
- Traefik will be running in a Docker container and will route traffic to the SSO server and other subdomains.

### 1. **Dynamic DNS Setup**

Since your domain `domain.tld` has a dynamic IP, use a Dynamic DNS (DDNS) provider that automatically updates the DNS records whenever your IP changes. Many domain registrars offer DDNS services or you can use third-party services like **Cloudflare**, **DuckDNS**, etc.

For **Let's Encrypt** to function properly, your DNS provider must allow Traefik to verify domain ownership via HTTP-01 or DNS-01 challenge. Ensure your DDNS provider supports this.

### 2. **Docker Compose File (`docker-compose.yml`)**

The `docker-compose.yml` will define the Traefik container along with the other services, including your **Synology SSO server** and an error page.

```yaml
version: "3.7"

services:
  # Traefik service (reverse proxy with Let's Encrypt)
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--api.insecure=true"  # Enable the Traefik dashboard (optional, only for testing)
      - "--providers.docker=true"  # Enable Docker provider
      - "--entryPoints.web.address=:80"  # HTTP entry point for Let's Encrypt HTTP challenge
      - "--entryPoints.websecure.address=:443"  # HTTPS entry point
      - "--certificatesResolvers.le.acme.httpChallenge.entryPoint=web"  # HTTP-01 challenge for Let's Encrypt
      - "--certificatesResolvers.le.acme.email=your-email@domain.tld"  # Email for Let's Encrypt registration
      - "--certificatesResolvers.le.acme.storage=/letsencrypt/acme.json"  # Persistent storage for certificates
      - "--log.level=INFO"  # Log level (adjust for production)
      - "--accesslog=true"  # Enable access logs
    ports:
      - "11420:80"  # Expose HTTP port
      - "11421:443"  # Expose HTTPS port
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"  # To allow Traefik to talk to Docker API
      - "./letsencrypt:/letsencrypt"  # Store Let's Encrypt certificates
    networks:
      - web

  # Synology SSO Server (example)
  sso-server:
    image: your-sso-image  # Replace with your actual Synology SSO image
    container_name: sso-server
    environment:
      - "SSO_SERVER=true"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sso.rule=Host(`sso.domain.tld`)"
      - "traefik.http.routers.sso.entrypoints=websecure"
      - "traefik.http.services.sso.loadbalancer.server.port=11420"  # Internal port of your SSO server
    networks:
      - web

  # Error page container
  error-page:
    image: nginx:alpine  # You can use any image that serves an error page
    container_name: error-page
    volumes:
      - "./error-page:/usr/share/nginx/html"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.error.rule=Host(`domain.tld`)"  # Redirect base domain to error page
      - "traefik.http.routers.error.entrypoints=websecure"
      - "traefik.http.services.error.loadbalancer.server.port=80"
    networks:
      - web

networks:
  web:
    external: true  # Assuming you have an external network for your services
```

#### Key Points:
- **Traefik Service**: It listens on ports `11420` and `11421`, which are mapped to HTTP and HTTPS, respectively. Traefik handles automatic SSL renewal using Let's Encrypt.
  - The `acme.json` file will store the certificates generated by Let's Encrypt. Ensure that this file is writable.
  - The `certificatesResolvers.le.acme.httpChallenge.entryPoint=web` defines that the HTTP-01 challenge is handled via port `80`.
  
- **Synology SSO Service**: This service is your Synology SSO server that will be exposed to `sso.domain.tld`. Replace the image with the correct one for your Synology SSO server.

- **Error Page Service**: This uses a basic `nginx` container that serves a static error page for `domain.tld`. You can replace the HTML content of the error page as needed.

### 3. **Traefik Configuration File (traefik.yml)**

This file is optional, but it allows for more advanced configuration and settings outside of the `docker-compose.yml`. Since Traefik configuration is already primarily handled by labels in the compose file, this is for additional custom configurations.

```yaml
api:
  insecure: true  # Exposes the dashboard on port 8080 (optional, for testing purposes)

log:
  level: INFO

accessLog: {}

certificatesResolvers:
  le:
    acme:
      email: "your-email@domain.tld"  # Email address for Let's Encrypt
      storage: /letsencrypt/acme.json
      httpChallenge:
        entryPoint: web  # Challenge through HTTP (port 80)
```

This configuration file is used for storing **ACME (Let's Encrypt)** configuration and additional logging. The storage path for `acme.json` should be persistent, hence itâ€™s mapped as a volume.

### 4. **Error Page (HTML Content)**

You can place a simple `index.html` for the error page that will be served by `nginx`:

```html
<!-- error-page/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>404 Error</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      color: #333;
    }
    h1 {
      font-size: 3em;
    }
  </style>
</head>
<body>
  <h1>404 - Page Not Found</h1>
</body>
</html>
```

This simple error page will be served when accessing `domain.tld`.

### 5. **Important Considerations**

- **DNS**: Ensure that your DNS provider properly supports wildcard subdomains (`*.domain.tld`) and points to the external IP of your router, which forwards ports `80` and `443` to the Dockerized Traefik.
- **Dynamic DNS**: Ensure that your dynamic DNS service is properly updating the IP of your domain as your external IP changes.

### 6. **Final Steps**

1. **Deploy the Docker Containers**:
   - Run the `docker-compose.yml` file by navigating to the directory containing it and running:
     ```bash
     docker-compose up -d
     ```

2. **Verify Let's Encrypt SSL**:
   - Traefik will automatically request certificates from Let's Encrypt for `domain.tld` and its subdomains, such as `sso.domain.tld`. You can check the logs to see the certificate request process:
     ```bash
     docker logs -f traefik
     ```

3. **Verify Error Page**:
   - Access `https://domain.tld` and you should be redirected to the error page.

4. **Check for Valid SSL**:
   - Access `https://sso.domain.tld` to ensure that SSL is correctly configured, and the SSO server is accessible.

This setup ensures that **Traefik** handles automatic SSL certificate management via **Let's Encrypt** for all subdomains and `domain.tld`, routes traffic to your Synology SSO server, and serves a custom error page for the base domain (`domain.tld`).

### Nginx Reverse "Plug-Ins" mentioned by the web & ChatGPT
|**Criterion**            |**Vouch Proxy**                              |**oauth2-proxy**                                                                               |
|-------------------------|---------------------------------------------|-----------------------------------------------------------------------------------------------|
|**Complexity**           |Simpler, fewer options                       |More configuration options but more complex                                                    |
|**OpenID Support**       |Excellent, focused directly on OpenID Connect|Supports OIDC but has a broader focus                                                          |
|**Resource Consumption** |Lower (minimalist approach)                  |- Higher (comprehensive feature set)<br>- one oauth2-proxy container per OAuth2/OpenID Provider|
|**Flexibility**          |Good, but limited in very complex scenarios  |Excellent, suitable for many scenarios                                                         |
|**Community and Support**|Smaller community                            |Larger community, better documentation                                                         |
Both Vouch and oauth2-proxy require more or less extensive configuration in the Nginx proxy host advanced settings which can be prone to inconsistencies.
Further alternatives considered:
- Caddy

## Nginx
## Authentik
### Synology SSO Server as OpenID Provider (OP) in Authentik
For setting up the SSO Server in Synology DSM, see [_Synology's KB - SSO Server_](https://kb.synology.com/en-us/DSM/help/SSOServer/sso_server_desc) or, as an example, [_How do I use Synology SSO Server to set up OIDC SSO for DSM?_](https://kb.synology.com/en-us/DSM/tutorial/set_up_oidc_for_dsm_in_sso_server).

For setting up Synology as an OP in Authentik, refer to the [Authentik Documentation](https://docs.goauthentik.io/docs/users-sources/sources/protocols/oauth/#openid-connect-authentik-20226) or:
1. Login and switch to the administration interface.
2. Go to _Directory > Federation & Social Login_.
3. Create a new authentication source of type _OpenID OAuth_ with, e.g., the following parameters:
    - **Name**: `DSM`
    - **Slug**: `dsm`
    - **Enabled**: `true`
    - **User Matching Mode**:
      - `Link to a user with identical email address` or
      - `Link to a user with identical username` (slightly less secure because of missing e-mail verification option)
    - **Group Matching Mode**: `Link to a group with identical name` or as required
    - **User Path**: `goauthentik.io/sources/%(slug)s`
    - **Protocol Settings**
      - **Consumer key/secret**: The client ID/secret from Synology's SSO application
      - **Scopes**: Leave empty unless required
    - **URL Settings**: Filled automatically once saved
    - **Flow Settings**: Leave as is
### Add Synology SSO Server as new OpenID Provider to Authentik Login Page
See [Federated and Social Sources](https://docs.goauthentik.io/docs/users-sources/sources/).
### Setup Authentik as Authentication Provider for Nginx Proxy Hosts
Here's some more info: https://geekscircuit.com/set-up-authentik-sso-with-nginx-proxy-manager/#create-new-provider

For now, _domain level forward authentication_ in Authentik doesn't seem to work as expected[^1][^2].

## Additional Sources
- https://www.reddit.com/r/navidrome/comments/r8834t/reverse_proxy_authentication_with_authentik/
- https://www.reddit.com/r/navidrome/comments/oa8gkz/guide_how_to_use_a_sso_solution_in_front_of/
- https://github.com/vouch/vouch-proxy

[^1]: https://www.reddit.com/r/Authentik/comments/1460g3z/domain_level_forward_auth_problem/
[^2]: https://github.com/goauthentik/authentik/discussions/2780
